generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./prisma/dev.db"
}

model Fellowship {
  id              Int                  @id @default(autoincrement())
  name            String
  code            String               @unique // The login code (e.g., "TCCF")
  logo            String? // Logo URL
  address         String?
  school          String?
  events          Event[]
  resources       Resource[]
  users           User[]
  transactions    Transaction[]
  songs           Song[]
  attendance      Attendance[]
  mediaPosts      MediaPost[]
  sessions        Session[]
  tasks           Task[]
  announcements   Announcement[]
  firstTimers     FirstTimer[]
  prayerRequests  PrayerRequest[]
  budgets         Budget[]
  calendarEvents  CalendarEvent[]
  expenseRequests ExpenseRequest[]
  publicPosts     PublicPost[]
  unitWallets     UnitWallet[] // Unit wallet system
  unitSettings    String?      // JSON string for unit configuration (e.g. merging units)
  commissions     BrainiacCommission[] // Commission tracking
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
}

model User {
  id                   Int                   @id @default(autoincrement())
  name                 String
  email                String                @unique
  username             String?               @unique // Member ID for login
  password             String
  role                 String // "GENERAL", "WORKER", "EXECUTIVE", "SUPER_ADMIN"
  department           String? // "FINANCE", "MUSIC", "PROTOCOL", "MEDIA", "PRESIDENCY", "ORGANIZING"
  isVerified           Boolean               @default(false)
  resetPasswordToken   String?
  resetPasswordExpires DateTime?
  fellowship           Fellowship?           @relation(fields: [fellowshipId], references: [id])
  fellowshipId         Int? // Optional for SUPER_ADMIN
  assignedTasks        Task[]                @relation("AssignedTasks")
  createdTasks         Task[]                @relation("CreatedTasks")
  announcements        Announcement[]
  followUps            FollowUp[]
  receipts             Receipt[]             @relation("uploadedReceipts")
  publicPosts          PublicPost[]          @relation("createdPosts")
  initiatedWithdrawals WalletTransaction[]   @relation("InitiatedWithdrawals")
  approvals            TransactionApproval[] // Approvals by this user
  donations            MemberDonation[] // Donations made by this user
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
}

model Task {
  id           Int        @id @default(autoincrement())
  title        String
  description  String?
  deadline     DateTime
  status       String     @default("PENDING") // "PENDING", "IN_PROGRESS", "COMPLETED"
  priority     String     @default("MEDIUM") // "LOW", "MEDIUM", "HIGH"
  assignedTo   User       @relation("AssignedTasks", fields: [assignedToId], references: [id])
  assignedToId Int
  createdBy    User       @relation("CreatedTasks", fields: [createdById], references: [id])
  createdById  Int
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Announcement {
  id           Int        @id @default(autoincrement())
  title        String
  content      String
  targetRoles  String     @default("[]") // JSON array: ["GENERAL", "WORKER", "EXECUTIVE"]
  targetDepts  String     @default("[]") // JSON array: ["MUSIC", "FINANCE", etc.] - empty means all
  createdBy    User       @relation(fields: [createdById], references: [id])
  createdById  Int
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
  sendPush     Boolean    @default(false)
  sendSMS      Boolean    @default(false)
  sendWhatsApp Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model FirstTimer {
  id           Int        @id @default(autoincrement())
  name         String
  phone        String?
  email        String?
  address      String?
  howHeard     String?
  visitDate    DateTime   @default(now())
  followedUp   Boolean    @default(false)
  followUps    FollowUp[]
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model FollowUp {
  id           Int        @id @default(autoincrement())
  firstTimer   FirstTimer @relation(fields: [firstTimerId], references: [id])
  firstTimerId Int
  agent        User       @relation(fields: [agentId], references: [id])
  agentId      Int
  notes        String
  nextAction   String?
  followUpDate DateTime   @default(now())
  createdAt    DateTime   @default(now())
}

model PrayerRequest {
  id            Int        @id @default(autoincrement())
  requestorName String
  request       String
  status        String     @default("PENDING") // "PENDING", "ANSWERED"
  isAnonymous   Boolean    @default(false)
  fellowship    Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId  Int
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

model Budget {
  id           Int        @id @default(autoincrement())
  title        String
  amount       Float
  period       String // "Monthly", "Quarterly", "Annual"
  department   String?
  status       String     @default("DRAFT") // "DRAFT", "SUBMITTED", "APPROVED", "REJECTED"
  approvedBy   Int?
  approvedAt   DateTime?
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Receipt {
  id            Int         @id @default(autoincrement())
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  transactionId Int
  fileUrl       String
  uploadedBy    User        @relation(name: "uploadedReceipts", fields: [uploadedById], references: [id])
  uploadedById  Int
  uploadedAt    DateTime    @default(now())
}

model CalendarEvent {
  id           Int        @id @default(autoincrement())
  title        String
  date         DateTime
  description  String?
  type         String // "Exam", "Holiday", "Fellowship Event", "Academic"
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
  createdAt    DateTime   @default(now())
}

model Event {
  id           Int        @id @default(autoincrement())
  title        String
  description  String?
  date         String
  time         String
  location     String
  type         String // "Service", "Study", "Youth", "Other"
  status       String     @default("UPCOMING") // "UPCOMING", "COMPLETED", "CANCELLED"
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
}

model Resource {
  id           Int        @id @default(autoincrement())
  title        String
  type         String // "PDF", "Video", "Audio"
  url          String
  size         String?
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
}

model Transaction {
  id           Int        @id @default(autoincrement())
  type         String // "INCOME", "EXPENSE"
  category     String // "TITHE", "OFFERING", "LOGISTICS", etc.
  amount       Float
  description  String
  date         DateTime   @default(now())
  status       String     @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  approvedBy   Int?
  approvedAt   DateTime?
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
  receipts     Receipt[]
}

model Song {
  id           Int        @id @default(autoincrement())
  title        String
  artist       String
  key          String?
  link         String?
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
}

model Attendance {
  id            Int        @id @default(autoincrement())
  date          DateTime   @default(now())
  menCount      Int
  womenCount    Int
  childrenCount Int
  total         Int
  serviceType   String // "Sunday Service", "Bible Study"
  fellowship    Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId  Int
}

model MediaPost {
  id            Int        @id @default(autoincrement())
  platform      String // "Facebook", "Instagram", "YouTube"
  content       String
  status        String // "Scheduled", "Posted"
  scheduledDate String
  fellowship    Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId  Int
}

model Session {
  id           Int        @id @default(autoincrement())
  name         String
  startDate    DateTime
  endDate      DateTime
  isActive     Boolean    @default(false)
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model ExpenseRequest {
  id           Int        @id @default(autoincrement())
  title        String
  description  String?
  amount       Float
  category     String
  status       String     @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  requestedBy  String
  requestedAt  DateTime   @default(now())
  approvedBy   Int?
  approvedAt   DateTime?
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model PublicPost {
  id           Int        @id @default(autoincrement())
  title        String
  content      String
  type         String // "ANNOUNCEMENT", "NEWSLETTER", "UPDATE", "EVENT"
  fellowship   Fellowship @relation(fields: [fellowshipId], references: [id])
  fellowshipId Int
  createdBy    User       @relation(name: "createdPosts", fields: [createdById], references: [id])
  createdById  Int
  isPublic     Boolean    @default(true)
  imageUrl     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// ============================================
// WALLET SYSTEM MODELS
// ============================================

// Unit Wallet - One per department per fellowship
model UnitWallet {
  id                 Int                 @id @default(autoincrement())
  fellowship         Fellowship          @relation(fields: [fellowshipId], references: [id])
  fellowshipId       Int
  unitDepartment     String // 'FINANCE', 'BIBLE_STUDY', 'PRAYER', 'WELFARE', etc.
  balance            Float               @default(0.00)
  vpayVirtualAccount String?             @unique // VPay-generated account number
  vpayAccountName    String? // Account name on VPay
  status             String              @default("ACTIVE") // "ACTIVE", "SUSPENDED", "CLOSED"
  transactions       WalletTransaction[]
  donations          MemberDonation[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@unique([fellowshipId, unitDepartment])
  @@index([fellowshipId])
  @@index([vpayVirtualAccount])
}

// Wallet Transaction - Deposits and Withdrawals
model WalletTransaction {
  id              Int                   @id @default(autoincrement())
  wallet          UnitWallet            @relation(fields: [walletId], references: [id])
  walletId        Int
  transactionType String // 'DEPOSIT', 'WITHDRAWAL', 'COMMISSION_DEDUCTION'
  amount          Float
  description     String?
  initiatedBy     User?                 @relation(name: "InitiatedWithdrawals", fields: [initiatedById], references: [id])
  initiatedById   Int?
  vpayReference   String?               @unique // VPay transaction reference
  bankReference   String? // Bank transfer reference for withdrawals
  status          String                @default("PENDING") // 'PENDING', 'APPROVED', 'REJECTED', 'COMPLETED', 'FAILED'
  approvals       TransactionApproval[]
  commission      BrainiacCommission?
  failureReason   String? // If failed, why?
  completedAt     DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([walletId])
  @@index([status])
  @@index([vpayReference])
}

// Transaction Approval Chain - Multi-level approval workflow
model TransactionApproval {
  id             Int               @id @default(autoincrement())
  transaction    WalletTransaction @relation(fields: [transactionId], references: [id])
  transactionId  Int
  approverRole   String // 'SECRETARY_GENERAL', 'PRESIDENCY', 'VICE_PRESIDENT', 'FINANCIAL_SECRETARY'
  approver       User?             @relation(fields: [approverId], references: [id])
  approverId     Int?
  approvalStatus String            @default("PENDING") // 'PENDING', 'APPROVED', 'REJECTED'
  comments       String?
  approvalOrder  Int // 1=SEC_GEN, 2=PRESIDENT, 3=VP, 4=SEC_GEN_FINAL, 5=FINANCIAL_SEC
  approvedAt     DateTime?
  createdAt      DateTime          @default(now())

  @@unique([transactionId, approvalOrder])
  @@index([transactionId])
  @@index([approvalStatus])
}

// Member Donations - Track individual member contributions
model MemberDonation {
  id            Int        @id @default(autoincrement())
  wallet        UnitWallet @relation(fields: [walletId], references: [id])
  walletId      Int
  member        User       @relation(fields: [memberId], references: [id])
  memberId      Int
  amount        Float
  paymentMethod String     @default("VPAY_TRANSFER") // 'VPAY_TRANSFER', 'CASH', 'BANK_TRANSFER'
  vpayReference String?    @unique
  donationNote  String? // Optional note from donor
  isAnonymous   Boolean    @default(false) // Hide donor from public view
  createdAt     DateTime   @default(now())

  @@index([walletId])
  @@index([memberId])
  @@index([vpayReference])
}

// Brainiac Commission - Track SaaS revenue
model BrainiacCommission {
  id             Int               @id @default(autoincrement())
  fellowship     Fellowship        @relation(fields: [fellowshipId], references: [id])
  fellowshipId   Int
  transaction    WalletTransaction @relation(fields: [transactionId], references: [id])
  transactionId  Int               @unique
  originalAmount Float // Total amount before fees
  vpayFee        Float // VPay's 1.5% fee
  brainiacCut    Float // Our 0.5-1% commission
  netAmount      Float // Amount credited to fellowship
  commissionRate Float             @default(0.005) // 0.5% default
  createdAt      DateTime          @default(now())

  @@index([fellowshipId])
  @@index([createdAt])
}
